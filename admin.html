<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedidos | Panel Admin</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <script>
 const firebaseConfig = {
  apiKey: "AIzaSyA4fVBCRgkhbTAaOyWg4cAkw7UXokF2uu8",
  authDomain: "pedidos-87064.firebaseapp.com",
  databaseURL: "https://pedidos-87064-default-rtdb.firebaseio.com",
  projectId: "pedidos-87064",
  storageBucket: "pedidos-87064.firebasestorage.app",
  messagingSenderId: "294352872886",
  appId: "1:294352872886:web:a5ffe0a214f23dca73cd17"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f2f2f2;padding:20px}
    h1{text-align:center;color:#4CAF50}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:8px;border:1px solid #ddd;text-align:center}
    th{background:#4CAF50;color:#fff}
    button{padding:4px 10px;border:none;border-radius:4px;cursor:pointer}
    .cerrar{background:#4CAF50;color:#fff}
    .cerrado{background:#9e9e9e;color:#fff;cursor:not-allowed}
    #filtro{margin:10px 0;padding:6px;width:200px}
    .reabrir{background:#FF9800;color:#fff} 
    .cancelar{background:#f44336;color:#fff} 
    button + button{ margin-left:6px; }

  </style>
</head>
<body>
  <h1>Panel de pedidos</h1>

  <input id="filtro" placeholder="Filtrar por ID…" />

  <table id="tabla">
    <thead>
      <tr>
        <th>ID</th>
        <th>Fecha</th>
        <th>Items</th>
        <th>Estado</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const tbody   = document.querySelector('#tabla tbody');
  const filtro  = document.getElementById('filtro');

  let pedidos   = {};           // cache local para filtrar

  // listener principal
db.ref('pedidos').on('value', snap => {
  pedidos = [];                        // ahora un array, no objeto

  snap.forEach(child => {              // recorro cada nodo hijo
    const p = child.val() || {};
    p.id    = child.key;               // key garantizada
    pedidos.push(p);
  });

  renderTabla();
});

  // filtrado en vivo
  filtro.addEventListener('input', renderTabla);

  function renderTabla(){
    const q = filtro.value.toLowerCase();
    tbody.innerHTML = '';

pedidos
  .filter(p => p.id.toLowerCase().includes(q))
      .sort((a,b)=> b.timestamp - a.timestamp)          // más nuevos arriba
      .forEach(p => {
        const tr = document.createElement('tr');

        // --- ID con link ---
        const link = document.createElement('a');
        link.href  = `pedidos.html?id=${p.id}&admin=true`;
        link.textContent = p.id;
        link.target = '_blank';
        tr.insertCell().appendChild(link);

        // --- fecha corta ---
        const fecha = new Date(p.timestamp);
        tr.insertCell().textContent =
          fecha.toLocaleDateString('es-AR') + ' ' +
          fecha.toLocaleTimeString('es-AR',{hour:'2-digit',minute:'2-digit'});

        // --- cantidad de ítems ---
        tr.insertCell().textContent = p.items.length;

        // --- estado ---
        tr.insertCell().textContent = p.locked ? 'CERRADO' : 'ABIERTO';

        // --- acciones ---
        const btn = document.createElement('button');
        if (p.locked){
          btn.textContent = 'Cerrado';
          btn.className   = 'cerrado';
          btn.disabled    = true;
        } else {
          btn.textContent = 'Cerrar';
          btn.className   = 'cerrar';
          btn.onclick = () => cerrarPedido(p.id);
        }
        tr.insertCell().appendChild(btn);

        const btnReabrir = document.createElement('button');

        if (p.locked) {
          btnReabrir.textContent = 'Reabrir';
          btnReabrir.className   = 'reabrir';           
          btnReabrir.onclick     = () => reabrirPedido(p.id);
          tr.lastChild.appendChild(btnReabrir);          // lo meto en la celda Acciones
        }

        // --- botón Cancelar ---
const btnCanc = document.createElement('button');
btnCanc.textContent = 'Cancelar';
btnCanc.className   = 'cancelar';
btnCanc.disabled    = p.locked;            // bloqueado si cerrado
btnCanc.onclick     = () => cancelarPedido(p.id, p.locked);
tr.lastChild.appendChild(btnCanc);


        tbody.appendChild(tr);
      });
  }

  function cerrarPedido(id){
    if(!confirm(`¿Bloquear el pedido ${id}?`)) return;
    db.ref(`pedidos/${id}`).update({ locked: true })
      .catch(()=>alert('Error al cerrar pedido'));
  }

  function reabrirPedido(id){
  if(!confirm(`¿Reabrir el pedido ${id}?`)) return;
  db.ref(`pedidos/${id}`).update({ locked:false })
    .catch(()=>alert('Error al reabrir pedido'));
}

function cancelarPedido(id, locked){
  if (locked) return;                                    // no borra cerrados
  if (!confirm(`¿Eliminar definitivamente el pedido ${id}?`)) return;

  db.ref(`pedidos/${id}`).remove()
    .catch(()=>alert('Error al cancelar'));
}


</script>
</body>
</html>
