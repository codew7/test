<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido | HomePoint</title>

    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
    <script src="config.js"></script>

    <script>
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>

  <script>
    let cotizacion = 0;
    let pedidoActual = null;

    fetch('https://api.bluelytics.com.ar/v2/latest')
    .then(r => r.json())
    .then(d => {
      cotizacion = (d.blue.value_sell || d.blue.sell) + 10;
      if (pedidoActual) renderItems();
    })
    .catch(() => alert('No pude obtener la cotización Blue'));
</script>


  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:20px;background:#f1f1f1;}
    h1{color:#4CAF50;text-align:center;}
    #items{max-width:600px;margin:0 auto;background:#fff;border-radius:8px;padding:20px;}
    #items div{display:flex;justify-content:space-between;margin-bottom:10px;}
    #items input{width:60px;text-align:center;}
    button{background:#4CAF50;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;}
    button:disabled{background:#9e9e9e;cursor:not-allowed;}
    table{width:100%;border-collapse:collapse;margin:20px auto;background:#fff}
    th,td{padding:8px;border:1px solid #ddd;text-align:center}
    th{background:#4CAF50;color:#fff}
    #total{font-weight:bold;font-size:1.1em;margin-top:10px;text-align:right}
    #estado{font-weight:bold;text-align:center;margin:20px 0}
    #total {text-align:right;font-weight:bold;font-size:1.1em;margin-top:10px}

  </style>
</head>
<body>
  <h1>Detalle del pedido</h1>
  <div id="nombreCliente" style="text-align:center;font-weight:bold;font-size:1.1em"></div>
  <div id="direccionCliente" style="text-align:center;margin-bottom:4px"></div>
  <div id="estado"></div>
  <div id="items"></div>

  <div style="text-align:center;margin-top:20px;">
    <button id="agregarItemBtn">Agregar Artículos</button>
    <button id="guardarBtn">Guardar Cambios</button>
    <button id="cerrarBtn">Cerrar Pedido</button>
    <button id="reabrirBtn">Reabrir Pedido</button>
    <button id="cancelarBtn">Cancelar Pedido</button>
  </div>

<script>
  const qs    = new URLSearchParams(location.search);
  const id    = qs.get('id');
  const admin = qs.get('admin') === 'true';

  if (!id){ document.body.innerHTML = "<p>ID inválido</p>"; throw 'no-id'; }

  const pedidoRef = db.ref('pedidos/'+id);

pedidoRef.on('value', snap => {
  pedidoActual = snap.val();
  if (!pedidoActual){
    document.body.innerHTML = "<p>Pedido no encontrado</p>";
    return;
  }

  /* === NUEVO: pintar nombre y dirección === */
  document.getElementById('nombreCliente').textContent =
    pedidoActual.cliente?.nombre || '';
  document.getElementById('direccionCliente').textContent =
    pedidoActual.cliente?.direccion || '';

  document.getElementById('estado').innerText =
    pedidoActual.locked ? "🔒 Pedido cerrado" : "📝 Pedido abierto";

  // solo pinto si ya tengo la cotización
  if (cotizacion) renderItems();

  const bloqueado = pedidoActual.locked;

  document.getElementById('agregarItemBtn').disabled = bloqueado;
  document.getElementById('guardarBtn').disabled     = bloqueado;
  document.getElementById('cancelarBtn').disabled    = bloqueado;

  // visibilidad de botones según rol/estado
  document.getElementById('cerrarBtn').style.display   =
    admin && !bloqueado ? 'inline-block' : 'none';

  document.getElementById('reabrirBtn').style.display  =
    admin &&  bloqueado ? 'inline-block' : 'none';
});

  let catalogo = {}; // Diccionario: nombre artículo -> URL imagen
  
  // Función para cargar el catálogo desde Google Sheets (exportado como CSV)
  function loadCatalogo() {
    // Reemplaza 'URL_CSV_GOOGLE_SHEETS' con la URL de exportación CSV de tu hoja de cálculo
    fetch('URL_CSV_GOOGLE_SHEETS')
      .then(response => response.text())
      .then(csv => {
        const rows = csv.split('\n').slice(1); // asumiendo que la primera fila es header
        rows.forEach(row => {
          const cols = row.split(',');
          if (cols.length >= 2) {
            const nombre = cols[0].trim();
            const imagen = cols[1].trim();
            catalogo[nombre] = imagen;
          }
        });
      })
      .catch(err => console.error("Error cargando el catálogo:", err));
  }
  
  // Llama al cargar la página para tener disponible el catálogo
  loadCatalogo();
  
  function renderItems(){
    const cont = document.getElementById('items');
    cont.innerHTML = '';

    const tbl = document.createElement('table');
    tbl.innerHTML = `
      <tr>
        <th>Artículo</th>
        <th>Cant.</th>
        <th>Valor $</th>
        <th>Subtotal $</th>
        <th></th>
      </tr>`;

    let total = 0;

    pedidoActual.items.forEach((it, idx) => {
      const unitPesos = Math.round((it.valorUSD || 0) * cotizacion);
      const subtotal  = Math.round(it.cantidad * unitPesos);
      total += subtotal;

      const row = tbl.insertRow(-1);

      // Celda con el nombre: al hacer clic muestra la imagen asociada
      const nameCell = row.insertCell(0);
      nameCell.textContent = it.nombre;
      nameCell.style.cursor = 'pointer';
      nameCell.onclick = () => showItemImage(it.nombre);
      
      const qty = document.createElement('input');
      qty.type='number'; qty.min=1; qty.value=it.cantidad;
      qty.onchange = e => { 
        pedidoActual.items[idx].cantidad = parseInt(e.target.value); 
        renderItems(); 
      };
      row.insertCell(1).appendChild(qty);

      row.insertCell(2).textContent = unitPesos.toLocaleString('es-AR');
      row.insertCell(3).textContent = subtotal.toLocaleString('es-AR');

      const del = document.createElement('button');
      del.textContent = 'X';
      del.onclick = () => { pedidoActual.items.splice(idx,1); renderItems(); };
      row.insertCell(4).appendChild(del);
    });

    cont.appendChild(tbl);

    let totalDiv = document.getElementById('total');
    if (!totalDiv){
      totalDiv = document.createElement('div');
      totalDiv.id = 'total';
      cont.appendChild(totalDiv);
    }
    totalDiv.textContent = `TOTAL $ ${total.toLocaleString('es-AR')}`;
  }

  // Función que muestra la imagen en un modal
  function showItemImage(nombre) {
    const imagenUrl = catalogo[nombre];
    if (!imagenUrl) {
      alert("No se encontró imagen para el artículo: " + nombre);
      return;
    }
  
    const modal = document.createElement('div');
    modal.style.position = 'fixed';
    modal.style.top = 0;
    modal.style.left = 0;
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.background = 'rgba(0,0,0,0.5)';
    modal.style.display = 'flex';
    modal.style.justifyContent = 'center';
    modal.style.alignItems = 'center';
    modal.style.zIndex = 1000;
    
    const img = document.createElement('img');
    img.src = imagenUrl;
    img.style.maxWidth = '90%';
    img.style.maxHeight = '90%';
    img.style.border = '5px solid #fff';
    img.style.borderRadius = '8px';
  
    // Cierra el modal haciendo clic en cualquier parte del overlay
    modal.onclick = () => modal.remove();
  
    modal.appendChild(img);
    document.body.appendChild(modal);
  }
  
  /* -------- BOTÓN PARA IR AL CATÁLOGO EN MODO EDICIÓN -------- */
  document.getElementById('agregarItemBtn').onclick = () => {
    if (pedidoActual.locked) return;
    window.location.href = `mayorista.html?pedido=${id}`;
  };

  document.getElementById('guardarBtn').onclick = () => {
    pedidoRef.update({ items: pedidoActual.items })
      .then(()=>alert("Pedido actualizado ✔️"))
      .catch(()=>alert("Error al guardar"));
  };

  document.getElementById('cerrarBtn').onclick = () => {
    if (!confirm("¿Cerrar definitivamente el pedido?")) return;
    pedidoRef.update({ locked:true }).then(()=>alert("Pedido cerrado"));
  };

  document.getElementById('reabrirBtn').onclick = () => {
  if (!admin || !pedidoActual.locked) return;            // solo admin y pedido cerrado
  if (!confirm("¿Querés reabrir este pedido?")) return;

  pedidoRef.update({ locked:false })
    .then(() => alert("Pedido reabierto"))
    .catch(() => alert("Error al reabrir"));
  };

  document.getElementById('cancelarBtn').onclick = () => {
  if (pedidoActual.locked) return;                              // bloqueado si está cerrado
  if (!confirm("¿Seguro querés cancelar y eliminar el pedido?")) return;

  pedidoRef.remove()
    .then(() => {
      alert("Pedido cancelado");
      window.location.href = "mayorista.html";                   // o a donde quieras redirigir
    })
    .catch(() => alert("Error al cancelar"));
};

</script>
</body>
</html>